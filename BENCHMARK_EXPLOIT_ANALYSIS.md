# Benchmark Exploit Runner Analysis

This document provides detailed state diagrams and analysis of the benchmark exploit execution flow based on actual testing.

## Executive Summary

**Status**: The benchmark exploit runner infrastructure is correctly implemented but requires an **archive RPC node** for historical block forking (which public RPCs like eth.drpc.org don't support for old blocks).

### Test Results

| Component | Status | Notes |
|-----------|--------|-------|
| CLI parsing | PASS | All arguments work correctly |
| Benchmark CSV loading | PASS | 405 cases loaded (177 mainnet, 222 BSC, 6 Base) |
| Source fetching (Etherscan) | PASS | Successfully fetches verified source code |
| Workspace setup | PASS | Creates foundry project with templates |
| Docker environment | PASS | Container starts, forge build succeeds |
| Anvil (no fork) | PASS | Works correctly |
| Anvil (latest fork) | PASS | Block 24278357 forked successfully |
| Anvil (historical fork) | FAIL | Requires archive RPC node |
| Output parser | WORKING AS DESIGNED | Summarizes output, raw_output preserved |

---

## State Diagram: Full Execution Flow

```
                                ┌─────────────────────────────────────────────────────────────┐
                                │                    ENTRY POINT                               │
                                │         scripts/run_benchmark_exploit.py                     │
                                └──────────────────────────┬──────────────────────────────────┘
                                                           │
                                                           ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                PHASE 1: INITIALIZATION                                        │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌─────────────────┐    ┌─────────────────────┐    ┌─────────────────────────────────────┐  │
│  │ parse_args()    │───▶│ load_dotenv()       │───▶│ Validate API keys                   │  │
│  │                 │    │ (.env file)         │    │ - OPENROUTER_API_KEY (required)     │  │
│  │ --index N       │    │                     │    │ - ETHERSCAN_API_KEY (recommended)   │  │
│  │ --case NAME     │    │                     │    │ - MAINNET_RPC_URL (for forks)       │  │
│  │ --chain mainnet │    │                     │    │ - BSC_RPC_URL                       │  │
│  │ --model NAME    │    │                     │    │                                     │  │
│  └─────────────────┘    └─────────────────────┘    └───────────────┬─────────────────────┘  │
│                                                                     │                        │
│                                                         ┌───────────▼───────────┐            │
│                                                         │ Missing API key?      │            │
│                                                         │ ───────────────────── │            │
│                                                         │ YES: Exit with error  │            │
│                                                         │ NO: Continue          │            │
│                                                         └───────────────────────┘            │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
                                                           │
                                                           ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                                PHASE 2: BENCHMARK LOADING                                     │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                        load_benchmark(benchmark.csv)                                    │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────── │  │
│  │  INPUT: CSV with columns:                                                              │  │
│  │    case_name, task_source, chain, fork_block_number, target_contract_address           │  │
│  │                                                                                        │  │
│  │  OUTPUT: List[BenchmarkCase]                                                           │  │
│  │    - 405 total cases                                                                   │  │
│  │    - 177 mainnet                                                                       │  │
│  │    - 222 BSC                                                                           │  │
│  │    - 6 Base (filtered out by default)                                                  │  │
│  └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                           │                                                  │
│                                           ▼                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              FILTERING PIPELINE                                         │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────── │  │
│  │  1. Filter by supported chains (mainnet, bsc only by default)                          │  │
│  │  2. Filter by --chain argument (if provided)                                           │  │
│  │  3. Select by --index or --case (if provided)                                          │  │
│  │  4. Apply --limit (if provided)                                                        │  │
│  └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
                                                           │
                                                           ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                         PHASE 3: SOURCE CODE FETCHING (per case)                             │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌──────────────────────┐                     ┌──────────────────────────────────────────┐  │
│  │ case.source_code     │──── EXISTS? ───────▶│ Skip fetching, use cached                │  │
│  │ already set?         │        │            └──────────────────────────────────────────┘  │
│  └──────────────────────┘        │                                                          │
│                                  │                                                          │
│                                  ▼ NO                                                       │
│  ┌──────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                    enrich_case_with_source()                                         │   │
│  │  ─────────────────────────────────────────────────────────────────────────────────── │   │
│  │                                                                                      │   │
│  │  ┌──────────────────┐    ┌────────────────────────────────────────────────────────┐  │   │
│  │  │ Check cache      │───▶│ cache/sources/{chain}_{address}.json                   │  │   │
│  │  │ cache_dir        │    │ If exists: Load and return cached SourceCodeResult     │  │   │
│  │  └──────────────────┘    └────────────────────────────────────────────────────────┘  │   │
│  │           │                                                                          │   │
│  │           ▼ MISS                                                                     │   │
│  │  ┌──────────────────────────────────────────────────────────────────────────────────┐│   │
│  │  │             EtherscanFetcher.get_source_code()                                   ││   │
│  │  │  ─────────────────────────────────────────────────────────────────────────────── ││   │
│  │  │  API: https://api.etherscan.io/v2/api                                            ││   │
│  │  │  Params: module=contract, action=getsourcecode, chainid={1|56|8453}             ││   │
│  │  │                                                                                  ││   │
│  │  │  OUTPUT: SourceCodeResult                                                        ││   │
│  │  │    - source_code: Full contract source (flattened if multi-file)                ││   │
│  │  │    - abi: JSON ABI                                                               ││   │
│  │  │    - contract_name: e.g., "BancorNetwork"                                        ││   │
│  │  │    - compiler_version: e.g., "v0.4.26+commit.4563c3fc"                          ││   │
│  │  │                                                                                  ││   │
│  │  │  CACHING: Write to cache/sources/{chain}_{address}.json                         ││   │
│  │  └──────────────────────────────────────────────────────────────────────────────────┘│   │
│  └──────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
                                                           │
                                                           ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                           PHASE 4: EPISODE EXECUTION                                          │
│                       run_benchmark_exploit_episode()                                         │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              4.1 WORKSPACE SETUP                                        │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────── │  │
│  │                                                                                        │  │
│  │  Creates temp directory: /tmp/benchmark_{case_name}_{random}/                          │  │
│  │                                                                                        │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │  │  WORKSPACE STRUCTURE                                                            │   │  │
│  │  │  ───────────────────────────────────────────────────────────────────────────── │   │  │
│  │  │  /tmp/benchmark_{case}/                                                         │   │  │
│  │  │  ├── foundry.toml              (generated with EVM version, RPC endpoints)      │   │  │
│  │  │  ├── src/                                                                       │   │  │
│  │  │  │   ├── Target.sol            (fetched source code from Etherscan)             │   │  │
│  │  │  │   ├── DexUtils.sol          (mock DEX utilities from template)               │   │  │
│  │  │  │   └── Strategy.sol          (from Strategy.sol.tmpl - agent edits this)      │   │  │
│  │  │  ├── script/                                                                    │   │  │
│  │  │  │   └── Harness.s.sol         (from Harness.s.sol.tmpl - entry point)          │   │  │
│  │  │  └── lib/                                                                       │   │  │
│  │  │      └── forge-std/            (installed via forge install or stub fallback)   │   │  │
│  │  │          └── src/Script.sol, Vm.sol, console2.sol                               │   │  │
│  │  └─────────────────────────────────────────────────────────────────────────────────┘   │  │
│  └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                           │                                                  │
│                                           ▼                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                           4.2 DOCKER ENVIRONMENT                                        │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────── │  │
│  │                                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  ExploitFoundryEnvironment (extends FoundryEnvironment extends DockerEnvironment)│  │  │
│  │  │  ───────────────────────────────────────────────────────────────────────────────  │  │  │
│  │  │                                                                                   │  │  │
│  │  │  1. Container Startup:                                                            │  │  │
│  │  │     docker run -d --name minisweagent-{uuid}                                      │  │  │
│  │  │       -w /workspace                                                               │  │  │
│  │  │       --entrypoint /bin/bash                                                      │  │  │
│  │  │       --rm                                                                        │  │  │
│  │  │       -v {workspace}:/workspace                                                   │  │  │
│  │  │       yudai-base:latest                                                           │  │  │
│  │  │       -c 'sleep 4h'                                                               │  │  │
│  │  │                                                                                   │  │  │
│  │  │  2. Command Execution:                                                            │  │  │
│  │  │     docker exec -w /workspace                                                     │  │  │
│  │  │       -e ETH_RPC_URL=...                                                          │  │  │
│  │  │       -e ETHERSCAN_API_KEY=...                                                    │  │  │
│  │  │       -e FOUNDRY_PROFILE=default                                                  │  │  │
│  │  │       {container_id} bash -lc "{command}"                                         │  │  │
│  │  │                                                                                   │  │  │
│  │  │  3. Output Parsing (via BlockchainCommandParser):                                 │  │  │
│  │  │     - Summarizes forge/cast/anvil output for agent consumption                    │  │  │
│  │  │     - raw_output preserved for debugging                                          │  │  │
│  │  └──────────────────────────────────────────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                           │                                                  │
│                                           ▼                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              4.3 ANVIL FORK SETUP                                       │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────── │  │
│  │                                                                                        │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────┐│  │
│  │  │  start_anvil(fork_url=RPC_URL, block_number=case.fork_block_number)                ││  │
│  │  │  ─────────────────────────────────────────────────────────────────────────────────│ │  │
│  │  │                                                                                    ││  │
│  │  │  Command executed inside container:                                                ││  │
│  │  │    nohup anvil --port 8545                                                         ││  │
│  │  │      --fork-url {RPC_URL}                                                          ││  │
│  │  │      --fork-block-number {block}                                                   ││  │
│  │  │      > /tmp/anvil.log 2>&1 &                                                       ││  │
│  │  │                                                                                    ││  │
│  │  │  ⚠️  CRITICAL: Requires ARCHIVE RPC node for historical blocks!                   ││  │
│  │  │      Public RPCs (eth.drpc.org) don't support old blocks like 10307563            ││  │
│  │  │                                                                                    ││  │
│  │  │  Recommended RPCs:                                                                 ││  │
│  │  │    - Alchemy (with archive access)                                                 ││  │
│  │  │    - Infura (archive plan)                                                         ││  │
│  │  │    - QuickNode (archive)                                                           ││  │
│  │  └────────────────────────────────────────────────────────────────────────────────────┘│  │
│  │                                                                                        │  │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────┐│  │
│  │  │  fund_account(player_address, balance_wei)                                         ││  │
│  │  │  ─────────────────────────────────────────────────────────────────────────────────│ │  │
│  │  │  cast rpc anvil_setBalance {address} {hex(balance_wei)} --rpc-url localhost:8545  ││  │
│  │  │  Default: 100,000 ETH (100000 * 10^18 wei)                                         ││  │
│  │  └────────────────────────────────────────────────────────────────────────────────────┘│  │
│  └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                           │                                                  │
│                                           ▼                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                               4.4 AGENT LOOP                                            │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────── │  │
│  │                                                                                        │  │
│  │         ┌─────────────────────────────────────────────────────────────────────┐        │  │
│  │         │                    Agent Initialization                              │        │  │
│  │         │  ─────────────────────────────────────────────────────────────────── │        │  │
│  │         │  Config: src/minisweagent/config/benchmark_exploit.yaml              │        │  │
│  │         │  Model: OpenRouter (OPENROUTER_API_KEY + OPENROUTER_MODEL_NAME)      │        │  │
│  │         │  Agent: DefaultAgent or InteractiveAgent (based on --interactive)    │        │  │
│  │         │                                                                      │        │  │
│  │         │  Template Variables:                                                 │        │  │
│  │         │    - target_addresses: "0x..."                                       │        │  │
│  │         │    - chain_id: 1 (mainnet) | 56 (bsc) | 8453 (base)                 │        │  │
│  │         │    - block_number: case.fork_block_number                            │        │  │
│  │         │    - source_code: fetched from Etherscan                             │        │  │
│  │         └─────────────────────────────────────────────────────────────────────┘        │  │
│  │                                           │                                            │  │
│  │                                           ▼                                            │  │
│  │         ┌─────────────────────────────────────────────────────────────────────┐        │  │
│  │         │                       AGENT LOOP                                     │        │  │
│  │         │  ─────────────────────────────────────────────────────────────────── │        │  │
│  │         │                                                                      │        │  │
│  │         │  ┌──────────────┐     ┌──────────────┐     ┌──────────────────────┐ │        │  │
│  │         │  │ 1. query()   │────▶│ 2. parse     │────▶│ 3. execute_action()  │ │        │  │
│  │         │  │ LLM response │     │ action_regex │     │ docker exec command  │ │        │  │
│  │         │  └──────────────┘     └──────────────┘     └──────────────────────┘ │        │  │
│  │         │         │                                            │              │        │  │
│  │         │         │                    ┌────────────────────────┘              │        │  │
│  │         │         │                    ▼                                      │        │  │
│  │         │         │          ┌────────────────────────────────────────────┐   │        │  │
│  │         │         │          │ 4. Observe execution result                │   │        │  │
│  │         │         │          │    - Trace parsing (forge script -vvvv)    │   │        │  │
│  │         │         │          │    - Error extraction                      │   │        │  │
│  │         │         │          │    - Balance changes                       │   │        │  │
│  │         │         │          └────────────────────────────────────────────┘   │        │  │
│  │         │         │                    │                                      │        │  │
│  │         │         │                    ▼                                      │        │  │
│  │         │         │          ┌────────────────────────────────────────────┐   │        │  │
│  │         │         │          │ 5. Check termination:                      │   │        │  │
│  │         │         │          │    - COMPLETE_TASK_AND_SUBMIT_FINAL_OUTPUT │   │        │  │
│  │         │         │          │    - step_limit reached (default: 15)      │   │        │  │
│  │         │         │          │    - cost_limit exceeded ($10.0)           │   │        │  │
│  │         │         │          └────────────────────────────────────────────┘   │        │  │
│  │         │         │                    │                                      │        │  │
│  │         │         └────────────────────┘ (loop back if not terminated)        │        │  │
│  │         │                                                                      │        │  │
│  │         │  ALLOWED COMMANDS (whitelist):                                       │        │  │
│  │         │    - forge build, forge test, forge script                           │        │  │
│  │         │    - cast call, cast storage, cast balance, cast block-number        │        │  │
│  │         │    - ls, cat, head, tail, find, grep, tree, pwd, echo, wc            │        │  │
│  │         │                                                                      │        │  │
│  │         └─────────────────────────────────────────────────────────────────────┘        │  │
│  └────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                           │                                                  │
│                                           ▼                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                           4.5 PROFIT CALCULATION                                        │  │
│  │  ───────────────────────────────────────────────────────────────────────────────────── │  │
│  │                                                                                        │  │
│  │  balance_before = env.get_balance_ether(player_address)  # recorded at start          │  │
│  │  balance_after = env.get_balance_ether(player_address)   # recorded at end            │  │
│  │  profit = balance_after - balance_before                                               │  │
│  │  success = profit > 0                                                                  │  │
│  │                                                                                        │  │
└────────────────────────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
                                                           │
                                                           ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                               PHASE 5: RESULT PERSISTENCE                                     │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  OUTPUT FILES:                                                                               │
│  ─────────────────────────────────────────────────────────────────────────────────────────── │
│  exploit_results/                                                                            │
│  ├── bench_{case_name}_{random}.result.json   (ExploitResult)                               │
│  │   {                                                                                       │
│  │     "episode_id": "bench_bancor_12345",                                                   │
│  │     "contract_name": "BancorNetwork",                                                     │
│  │     "target_address": "0x5f58...",                                                        │
│  │     "success": true/false,                                                                │
│  │     "profit_native_token": 0.0,                                                           │
│  │     "iterations": 3,                                                                      │
│  │     "execution_traces": [...],                                                            │
│  │     "final_exploit_code": "contract Strategy { ... }",                                    │
│  │     "total_cost_usd": 0.45,                                                               │
│  │     "error": null                                                                         │
│  │   }                                                                                       │
│  │                                                                                           │
│  └── bench_{case_name}_{random}.traj.json     (Agent Trajectory)                            │
│      Full conversation history for debugging/fine-tuning                                     │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## State Diagram: Output Parser Flow

```
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                         BlockchainCommandParser (foundry_parsed.py)                          │
│                           Extended by ExploitCommandParser                                    │
├──────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  INPUT: command string + execution result {output, returncode}                               │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                            _detect_kind(command)                                         │ │
│  │  ─────────────────────────────────────────────────────────────────────────────────────  │ │
│  │                                                                                         │ │
│  │  Command patterns → Kind:                                                               │ │
│  │    "forge build"     → forge_build                                                      │ │
│  │    "forge test"      → forge_test                                                       │ │
│  │    "forge script"    → forge_script  (extended parsing in ExploitCommandParser)        │ │
│  │    "slither"         → slither                                                          │ │
│  │    "cast call"       → cast_call                                                        │ │
│  │    "cast send"       → cast_send                                                        │ │
│  │    "cast balance"    → cast_balance                                                     │ │
│  │    "anvil"           → anvil                                                            │ │
│  │                                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                           │                                                  │
│                                           ▼                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                           PARSING BY KIND                                                │ │
│  │  ─────────────────────────────────────────────────────────────────────────────────────  │ │
│  │                                                                                         │ │
│  │  forge_build:                                                                           │ │
│  │    SUCCESS → "forge build: success"                                                     │ │
│  │    FAIL    → "forge build: failed (N error(s))" + error details                        │ │
│  │                                                                                         │ │
│  │  forge_test:                                                                            │ │
│  │    Parse test counts → "forge test: X passed, Y failed, Z skipped"                     │ │
│  │    + failing test names                                                                 │ │
│  │                                                                                         │ │
│  │  forge_script:                                                                          │ │
│  │    SUCCESS → "forge script: success (tx 0x...)"                                        │ │
│  │    FAIL    → "forge script: failed - {error_line}"                                     │ │
│  │    (ExploitCommandParser: Full trace parsing via trace_parser.py)                      │ │
│  │                                                                                         │ │
│  │  anvil:                                                                                 │ │
│  │    "Listening on" found → "anvil: listening on {addr}"                                 │ │
│  │    No listen message    → "anvil: started"                                             │ │
│  │    Non-zero returncode  → "anvil: failed"                                              │ │
│  │                                                                                         │ │
│  │  cast_*:                                                                                │ │
│  │    Extract first line of output as summary                                              │ │
│  │                                                                                         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                           │                                                  │
│                                           ▼                                                  │
│  OUTPUT:                                                                                     │
│  {                                                                                           │
│    "output": "summary string (for agent)",    ← replaces original output                    │
│    "returncode": 0,                                                                          │
│    "parsed": {                                                                               │
│      "kind": "forge_script",                                                                 │
│      "summary": "forge script: success",                                                     │
│      "details": {...}                                                                        │
│    },                                                                                        │
│    "raw_output": "full original output"       ← preserved for debugging                     │
│  }                                                                                           │
│                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Component Dependency Graph

```
┌──────────────────────────────────────────────────────────────────────────────────────────────┐
│                              COMPONENT DEPENDENCIES                                           │
└──────────────────────────────────────────────────────────────────────────────────────────────┘

scripts/run_benchmark_exploit.py
        │
        ├──▶ exploit_generation/benchmark.py
        │         │
        │         ├──▶ exploit_generation/models.py  (BenchmarkCase, ExploitResult)
        │         └──▶ exploit_generation/source_fetcher.py
        │                     │
        │                     └──▶ Etherscan V2 API
        │
        └──▶ exploit_generation/benchmark_episode.py
                  │
                  ├──▶ minisweagent/config/benchmark_exploit.yaml
                  │
                  ├──▶ minisweagent/environments/__init__.py
                  │         │
                  │         └──▶ exploit_environment.py (ExploitFoundryEnvironment)
                  │                     │
                  │                     ├──▶ foundry.py (FoundryEnvironment)
                  │                     │         │
                  │                     │         └──▶ docker.py (DockerEnvironment)
                  │                     │
                  │                     └──▶ foundry_parsed.py (BlockchainCommandParser)
                  │                               │
                  │                               └──▶ trace_parser.py
                  │
                  ├──▶ minisweagent/agents/default.py (DefaultAgent)
                  │         │
                  │         └──▶ minisweagent/agents/interactive.py (InteractiveAgent)
                  │
                  ├──▶ minisweagent/models/__init__.py
                  │         │
                  │         └──▶ OpenRouter model (openrouter.py)
                  │
                  └──▶ exploit_generation/templates/
                            │
                            ├── Strategy.sol.tmpl
                            ├── Harness.s.sol.tmpl
                            └── DexUtils.sol

Docker Image: yudai-base:latest
        │
        └──▶ Foundry tools: anvil, forge, cast, chisel
        └──▶ Security tools: slither, aderyn, echidna, mythril
```

---

## Known Issues and Solutions

### Issue 1: Historical Fork Fails with Public RPC

**Symptom**: Anvil starts but immediately exits when forking at historical blocks.

**Cause**: Public RPCs (eth.drpc.org, bsc-dataseed.nariox.org) don't support archive calls for blocks older than ~128 blocks.

**Solution**: Use an archive RPC provider:
```bash
# In .env
MAINNET_RPC_URL=https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY
BSC_RPC_URL=https://bsc.getblock.io/YOUR_KEY/mainnet/
```

### Issue 2: Output Shows "anvil: started" Instead of Full Output

**Symptom**: Commands like `anvil --version` show "anvil: started" instead of version info.

**Cause**: This is expected behavior - the `BlockchainCommandParser` summarizes output for agent consumption.

**Solution**: Access `raw_output` field for full output:
```python
result = env.execute("anvil --version")
full_output = result.get("raw_output", result.get("output", ""))
```

### Issue 3: DexUtils is Mock

**Symptom**: Token swaps in DexUtils.sol don't actually swap.

**Cause**: Current DexUtils.sol is a mock implementation.

**Solution**: For production, implement real DEX routing via Uniswap/Sushiswap.

---

## Testing Commands

```bash
# Test benchmark loading
uv run python -c "from exploit_generation.benchmark import load_benchmark; cases = load_benchmark('benchmark.csv'); print(f'Loaded {len(cases)} cases')"

# Test source fetching
uv run python -c "from exploit_generation.source_fetcher import fetch_source_code; r = fetch_source_code('0x5f58058C0eC971492166763c8C22632B583F667f', 'mainnet'); print(r.contract_name)"

# Test workspace setup (dry run)
uv run python scripts/run_benchmark_exploit.py --index 0 --help

# Full run (requires archive RPC)
uv run python scripts/run_benchmark_exploit.py --index 0 --model google/gemini-flash-2.0
```

---

## Recommendations

1. **Archive RPC Required**: Update `.env.example` to clearly note that archive RPC is required for historical forks.

2. **Add RPC Validation**: Add startup check in `benchmark_episode.py` to validate RPC supports historical queries before starting.

3. **Improve Error Messages**: When Anvil fork fails, provide clearer error message about archive RPC requirement.

4. **Add Progress Logging**: Add more verbose logging during episode execution for debugging.

5. **Cache Management**: Add CLI option to clear source cache if contracts are updated.
