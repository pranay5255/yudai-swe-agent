import logging
from unittest.mock import patch

import pytest

from minisweagent.environments.exploit_environment import (
    ExploitCommandParser,
    ExploitFoundryEnvironment,
)
from minisweagent.environments.exploit_environment_v2 import (
    ExploitCommandParserV2,
    ExploitFoundryEnvironmentV2,
)
from minisweagent.environments.foundry import FoundryEnvironment
from minisweagent.environments.foundry_v2 import FoundryEnvironmentV2


def _make_exploit_env(env_cls, parser):
    env = env_cls.__new__(env_cls)
    env._parser = parser
    env.execution_traces = []
    env.logger = logging.getLogger(f"tests.{env_cls.__name__}")
    return env


@pytest.mark.parametrize(
    ("env_cls", "base_cls", "parser"),
    [
        (ExploitFoundryEnvironment, FoundryEnvironment, ExploitCommandParser()),
        (ExploitFoundryEnvironmentV2, FoundryEnvironmentV2, ExploitCommandParserV2()),
    ],
)
def test_execute_keeps_raw_output_when_parser_does_not_match(env_cls, base_cls, parser):
    env = _make_exploit_env(env_cls, parser)

    with patch.object(base_cls, "execute", return_value={"output": "not_running\n", "returncode": 0}):
        result = env.execute(
            "pgrep -fa '(^|/)anvil([[:space:]]|$).*--port' || echo 'not_running'",
        )

    assert result["output"] == "not_running\n"
    assert "parsed" not in result
    assert "raw_output" not in result


@pytest.mark.parametrize(
    ("env_cls", "base_cls", "parser"),
    [
        (ExploitFoundryEnvironment, FoundryEnvironment, ExploitCommandParser()),
        (ExploitFoundryEnvironmentV2, FoundryEnvironmentV2, ExploitCommandParserV2()),
    ],
)
def test_execute_preserves_raw_output_when_parser_matches(env_cls, base_cls, parser):
    env = _make_exploit_env(env_cls, parser)

    raw = "Listening on 127.0.0.1:8545\n"
    with patch.object(base_cls, "execute", return_value={"output": raw, "returncode": 0}):
        result = env.execute("anvil --port 8545")

    assert result["parsed"]["kind"] == "anvil"
    assert result["raw_output"] == raw
    assert "anvil: listening on 127.0.0.1:8545" in result["output"].lower()
