from __future__ import annotations
from pathlib import Path

from exploit_generation.benchmark_episode import (
    BenchmarkEpisodeConfig,
    get_rpc_urls,
    load_env,
    parse_balance_wei,
    run_benchmark_exploit_episode,
)
from exploit_generation.models import BenchmarkCase


def test_parse_balance_wei_supports_hex_decimal_and_eth_strings():
    assert parse_balance_wei("0x10") == 16
    assert parse_balance_wei("1000000000000000000") == 10**18
    assert parse_balance_wei("1.5") == int(1.5 * 10**18)


def test_get_rpc_urls_prefers_env_and_falls_back_to_defaults(monkeypatch):
    monkeypatch.setenv("MAINNET_RPC_URL", "https://mainnet.example")
    monkeypatch.setenv("BSC_RPC_URL", "https://bsc.example")
    monkeypatch.delenv("BASE_RPC_URL", raising=False)

    urls = get_rpc_urls()
    assert urls["mainnet"] == "https://mainnet.example"
    assert urls["bsc"] == "https://bsc.example"
    assert "base" in urls  # falls back to default when BASE_RPC_URL is unset


def test_load_env_delegates_to_dotenv(monkeypatch, tmp_path):
    calls = []

    def fake_load_dotenv(path: Path | None = None):
        calls.append(path)

    monkeypatch.setattr("exploit_generation.benchmark_episode.load_dotenv", fake_load_dotenv)
    env_file = tmp_path / ".env"
    env_file.write_text("X=1\n")

    load_env(env_file)
    load_env()

    assert calls[0] == env_file
    assert calls[1] is None


def _make_case() -> BenchmarkCase:
    return BenchmarkCase(
        case_name="selection_case",
        task_source="unit",
        chain="mainnet",
        fork_block_number=123,
        target_contract_address="0x1111111111111111111111111111111111111111",
        source_code="pragma solidity ^0.8.19; contract Target {}",
    )


def _run_episode_with_agent_selection(monkeypatch, tmp_path, *, yolo: bool, interactive: bool | None):
    records: dict[str, object] = {}

    class FakeEnv:
        def __init__(self):
            self.execution_traces = []
            self._balance_calls = 0

        def start_anvil(self, **kwargs):
            records["start_anvil"] = kwargs

        def get_anvil_rpc_url(self):
            return "http://127.0.0.1:8545"

        def fund_account(self, *args, **kwargs):  # noqa: ARG002
            return {"ok": True}

        def get_balance_ether(self, *args, **kwargs):  # noqa: ARG002
            self._balance_calls += 1
            return 100.0 if self._balance_calls == 1 else 101.0

        def execute(self, command, cwd="", timeout=None):  # noqa: ARG002
            return {"output": f"ok: {command}", "returncode": 0}

    class FakeModel:
        cost = 0.01
        n_calls = 1

    class FakeDefaultAgent:
        def __init__(self, model, env, **kwargs):  # noqa: ARG002
            records["agent"] = "default"
            self.model = model

        def run(self, task, **kwargs):  # noqa: ARG002
            return "finished", "ok"

    class FakeInteractiveAgent:
        def __init__(self, model, env, **kwargs):  # noqa: ARG002
            records["agent"] = "interactive"
            records["interactive_kwargs"] = kwargs
            self.model = model

        def run(self, task, **kwargs):  # noqa: ARG002
            return "finished", "ok"

    def fake_setup_workspace(workspace, case, player_address):  # noqa: ARG001
        (workspace / "src").mkdir(parents=True, exist_ok=True)
        (workspace / "src" / "Strategy.sol").write_text("contract Strategy {}")

    monkeypatch.setattr("exploit_generation.benchmark_episode._setup_workspace", fake_setup_workspace)
    monkeypatch.setattr("exploit_generation.benchmark_episode._read_yaml", lambda _path: {"agent": {}, "model": {}})
    monkeypatch.setattr("minisweagent.config.get_config_path", lambda _spec: Path("dummy.yaml"))
    monkeypatch.setattr("minisweagent.environments.get_environment", lambda _cfg: FakeEnv())
    monkeypatch.setattr("minisweagent.models.get_model", lambda _name, _cfg: FakeModel())
    monkeypatch.setattr("minisweagent.agents.default.DefaultAgent", FakeDefaultAgent)
    monkeypatch.setattr("minisweagent.agents.interactive.InteractiveAgent", FakeInteractiveAgent)
    monkeypatch.setattr("minisweagent.run.utils.save.save_traj", lambda *args, **kwargs: None)

    config = BenchmarkEpisodeConfig(
        case=_make_case(),
        output_dir=tmp_path,
        model_name="test-model",
        config_path="benchmark_exploit.yaml",
        docker_image="test-image",
        cost_limit=10.0,
        player_address="0x2222222222222222222222222222222222222222",
        player_balance_wei=10**18,
        rpc_urls={"mainnet": "https://mainnet.example"},
        yolo=yolo,
        interactive=interactive,
    )

    result = run_benchmark_exploit_episode(config)
    return result, records


def test_run_episode_uses_interactive_agent_by_default_when_yolo_enabled(monkeypatch, tmp_path):
    result, records = _run_episode_with_agent_selection(
        monkeypatch,
        tmp_path,
        yolo=True,
        interactive=None,
    )

    assert result.success is True
    assert records["agent"] == "interactive"
    assert records["interactive_kwargs"]["mode"] == "yolo"


def test_run_episode_respects_explicit_non_interactive_override(monkeypatch, tmp_path):
    result, records = _run_episode_with_agent_selection(
        monkeypatch,
        tmp_path,
        yolo=True,
        interactive=False,
    )

    assert result.success is True
    assert records["agent"] == "default"
