#!/usr/bin/env python3
"""Run exploit-generation tasks using a Foundry forked environment."""

from __future__ import annotations

import os
import traceback
from pathlib import Path
from typing import Any

import typer
import yaml
from rich.console import Console

from minisweagent import global_config_dir
from minisweagent.agents.default import DefaultAgent
from minisweagent.config import builtin_config_dir, get_config_path
from minisweagent.environments import get_environment
from minisweagent.models import get_model
from minisweagent.run.utils.save import save_traj
from minisweagent.utils.log import logger

app = typer.Typer(rich_markup_mode="rich")
console = Console(highlight=False)

DEFAULT_CONFIG = builtin_config_dir / "foundry_exploit.yaml"
DEFAULT_OUTPUT = global_config_dir / "last_exploit_run.traj.json"


@app.command()
def main(
    task: str = typer.Option(..., "-t", "--task", help="Exploit task description", show_default=False, prompt=True),
    model_name: str | None = typer.Option(None, "-m", "--model", help="Model name override"),
    model_class: str | None = typer.Option(None, "--model-class", help="Model class override"),
    config_spec: Path = typer.Option(DEFAULT_CONFIG, "-c", "--config", help="Config name or path"),
    output: Path | None = typer.Option(DEFAULT_OUTPUT, "-o", "--output", help="Output trajectory file"),
    yolo: bool = typer.Option(False, "-y", "--yolo", help="Run without confirmation"),
    cost_limit: float | None = typer.Option(None, "-l", "--cost-limit", help="Cost limit override"),
    project: Path | None = typer.Option(None, "--project", help="Host path to mount into the container"),
    chain_id: int = typer.Option(1, "--chain-id", help="Chain ID for the fork"),
    block_number: int | None = typer.Option(None, "--block-number", help="Fork block number"),
    address: list[str] = typer.Option(None, "-a", "--address", help="Target contract address (repeatable)"),
    fork_url: str | None = typer.Option(
        None, "--fork-url", envvar="ETH_RPC_URL", help="Fork RPC URL (defaults to ETH_RPC_URL)"
    ),
) -> Any:
    config_path = get_config_path(config_spec)
    console.print(f"Loading agent config from [bold green]'{config_path}'[/bold green]")
    config = yaml.safe_load(config_path.read_text())

    if yolo:
        config.setdefault("agent", {})["mode"] = "yolo"
    if cost_limit is not None:
        config.setdefault("agent", {})["cost_limit"] = cost_limit
    if model_class is not None:
        config.setdefault("model", {})["model_class"] = model_class

    env_config = config.setdefault("environment", {})
    if project is not None:
        env_config["project_path"] = str(project)
    if fork_url is not None:
        env_config["anvil_fork_url"] = fork_url

    if model_name is None:
        model_name = os.getenv("OPENROUTER_MODEL_NAME") or model_name
    model = get_model(model_name, config.get("model", {}))
    env = get_environment(env_config)
    agent = DefaultAgent(model, env, **config.get("agent", {}))

    target_addresses = address or []
    address_block = "\n".join(f"- {addr}" for addr in target_addresses) or "- (none provided)"
    block_number_display = block_number if block_number is not None else "latest"

    exit_status, result, extra_info = None, None, None
    try:
        exit_status, result = agent.run(
            task,
            target_addresses=address_block,
            chain_id=chain_id,
            block_number=block_number,
            block_number_display=block_number_display,
        )
    except Exception as e:
        logger.error(f"Error running exploit agent: {e}", exc_info=True)
        exit_status, result = type(e).__name__, str(e)
        extra_info = {"traceback": traceback.format_exc()}
    finally:
        if output:
            save_traj(agent, output, exit_status=exit_status, result=result, extra_info=extra_info)

    return agent


if __name__ == "__main__":
    app()
