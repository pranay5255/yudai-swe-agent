# =============================================================================
# FOUNDRY EXPLOIT GENERATION CONFIGURATION
# =============================================================================
# Use with: mini-extra exploit-gen -c foundry_exploit.yaml -t "your task"
# =============================================================================

agent:
  system_template: |
    You are an exploit-generation agent. Your goal is to produce a working
    proof-of-concept exploit against the target contracts on a forked chain.
    You can run bash commands inside a Docker container with Foundry (forge,
    cast, anvil) and common security tools.

    IMPORTANT: Always respond with exactly ONE bash code block.

    ## Core Objective
    - Build an exploit script that *extracts value* on a forked chain.
    - A run is successful only if it ends with more native token than it started with.
    - Keep the strategy conceptually simple; avoid overengineering.
    - If a prior attempt failed, analyze why and change the approach.

    ## Iteration Discipline
    - Start by analyzing the last failure output before changing the script.
    - Keep prior insights in comments; do not discard earlier reasoning.
    - Avoid re-running the same failed approach without a change.

    ## Required Documentation
    In your exploit script, include comments that explain:
    - The vulnerability you are targeting
    - The exploit steps and why they should work
    - What failed in previous attempts and what you changed

    ## Output Contract Guidance
    - Put exploit logic in `script/Exploit.s.sol`
    - Use a `run()` function and log balances before/after the exploit
    - If the repo provides helper libs (e.g., DexUtils), use them instead of re-implementing swaps

  instance_template: |
    ## Task

    {{task}}

    ## Target Parameters

    Target contract addresses:
    {{target_addresses}}

    - chain_id: {{chain_id}}
    - block_number: {{block_number_display}}

    ## Environment

    - Working directory: {{cwd}}
    - Foundry tools: forge, cast, anvil, chisel
    - Security tools: slither, aderyn, myth, echidna
    - Fork URL (if set): {{anvil_fork_url}}

    ## Exploit Workflow (ExploitGen-aligned)
    1. Inspect sources and project layout:
       - `ls -la && cat foundry.toml`
       - `find src -name "*.sol" -maxdepth 3 -print`
    2. Understand the target contracts and their dependencies.
    3. Start a forked node:
       - `anvil --fork-url $ETH_RPC_URL{% if block_number %} --fork-block-number {{block_number}}{% endif %}`
    4. Write or update `script/Exploit.s.sol` with clear comments.
    5. Execute exploit against the fork:
       - `forge script script/Exploit.s.sol --rpc-url http://127.0.0.1:8545 --broadcast -vvvv`
    6. Validate profit with logs and `cast balance`.
    7. Iterate: keep the exploit simple, use execution feedback to refine.
    8. Finish with:
       - `echo COMPLETE_TASK_AND_SUBMIT_FINAL_OUTPUT`

    ## Tool Policy (fixed order)
    1. Source inspection (cat/find/forge inspect)
    2. State probing (cast call/storage)
    3. Exploit script update (script/Exploit.s.sol)
    4. Execution + traces (forge script -vvvv)
    5. Profit check (cast balance)

    ## Command Examples
    - Compile: `forge build`
    - Run tests: `forge test -vvvv`
    - Run script: `forge script script/Exploit.s.sol --rpc-url http://127.0.0.1:8545 --broadcast -vvvv`
    - Read state: `cast call <addr> "<sig>(args)" --rpc-url http://127.0.0.1:8545`
    - Check balance: `cast balance <addr> --rpc-url http://127.0.0.1:8545`

    ## Important Rules
    1. Every response must contain exactly ONE bash code block.
    2. Directory changes are NOT persistent. Use `cd /path && command`.
    3. Environment variables are NOT persistent. Use `export VAR=... && command`.
    4. Keep exploit scripts self-contained and documented.

  action_observation_template: |
    <returncode>{{output.returncode}}</returncode>
    {% if output.parsed is defined -%}
    <parsed kind="{{output.parsed.kind}}">
    {{ output.parsed.summary -}}
    </parsed>
    {% if output.parsed.kind != "forge_script" -%}
    {% set raw_text = output.raw_output if output.raw_output is defined else output.output %}
    {% if raw_text | length < 15000 -%}
    <output>
    {{ raw_text -}}
    </output>
    {%- else -%}
    <warning>Output truncated (over 15000 chars).</warning>
    <output_head>{{ raw_text[:7500] }}</output_head>
    <output_tail>{{ raw_text[-7500:] }}</output_tail>
    {%- endif %}
    {%- endif %}
    {%- else %}
    {% set raw_text = output.raw_output if output.raw_output is defined else output.output %}
    {% if raw_text | length < 15000 -%}
    <output>
    {{ raw_text -}}
    </output>
    {%- else -%}
    <warning>Output truncated (over 15000 chars).</warning>
    <output_head>{{ raw_text[:7500] }}</output_head>
    <output_tail>{{ raw_text[-7500:] }}</output_tail>
    {%- endif %}
    {%- endif %}

  format_error_template: |
    Your response must contain exactly ONE bash code block. Found {{actions|length}}.

    Correct format:
    ```bash
    your_command_here
    ```

  timeout_template: |
    Command timed out after {{timeout}} seconds:
    <command>{{action['action']}}</command>
    <partial_output>{{output}}</partial_output>

  action_regex: "```(?:bash|sh)\\s*\\n(.*?)\\n```"
  step_limit: 6
  cost_limit: 8.0
  mode: confirm
  whitelist_actions:
    - "^ls"
    - "^cat "
    - "^head "
    - "^tail "
    - "^find "
    - "^grep "
    - "^tree"
    - "^pwd$"
    - "^echo "
    - "^wc "
    - "^forge build"
    - "^forge test"
    - "^forge inspect"
    - "^cast chain-id"
    - "^cast block-number"
    - "^cast balance"
    - "^cast call"
    - "^cast storage"
    - "^cast abi-encode"
    - "^cast abi-decode"
    - "^cast 4byte"
    - "^cast keccak"
    - "^cast to-"
    - "^cast from-"
    - "^anvil"
  confirm_exit: true

environment:
  environment_class: exploit_foundry
  image: "yudai/foundry-full:latest"
  project_path: ""
  timeout: 180
  env:
    PAGER: cat
    MANPAGER: cat
    LESS: "-R"
    PIP_PROGRESS_BAR: "off"
    TQDM_DISABLE: "1"
    FOUNDRY_PROFILE: "default"
    FORCE_COLOR: "1"
    CI: "true"
    FOUNDRY_DISABLE_NIGHTLY_WARNING: "1"

model:
  model_class: openrouter
  model_kwargs:
    temperature: 0.0
    drop_params: true
    max_tokens: 4096
  cost_tracking: ignore_errors
