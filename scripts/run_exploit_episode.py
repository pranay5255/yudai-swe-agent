#!/usr/bin/env python3
"""Run a single exploit-generation episode against a local contract."""

from __future__ import annotations

import argparse
import os
import sys
from pathlib import Path

from exploit_generation.episode import EpisodeConfig, load_env, parse_balance_wei, run_local_exploit_episode


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Run a local exploit episode (single contract).")
    parser.add_argument("--contract", type=Path, default=None, help="Path to target contract")
    parser.add_argument("--output", type=Path, default=None, help="Output directory for results")
    parser.add_argument("--config", type=str, default=None, help="Agent config name or path")
    parser.add_argument("--model", type=str, default=None, help="Model name override")
    parser.add_argument("--image", type=str, default=None, help="Docker image override")
    parser.add_argument("--cost-limit", type=float, default=None, help="Cost limit override")
    parser.add_argument("--no-yolo", action="store_true", help="Disable yolo mode")
    parser.add_argument("--env-file", type=Path, default=None, help="Path to .env file")
    return parser.parse_args()


def main() -> int:
    args = parse_args()
    project_root = Path(__file__).parent.parent
    sys.path.insert(0, str(project_root))

    env_file = args.env_file or (project_root / ".env")
    if env_file.exists():
        load_env(env_file)
        print(f"Loaded environment from {env_file}")
    else:
        load_env()
        print(f"Warning: No .env file found at {env_file}")

    api_key = os.getenv("OPENROUTER_API_KEY")
    if not api_key:
        print("Error: OPENROUTER_API_KEY not set in environment or .env file")
        return 1

    model_name = args.model or os.getenv("OPENROUTER_MODEL_NAME")
    if not model_name:
        print("Error: OPENROUTER_MODEL_NAME not set in environment or provided via --model")
        return 1

    contract_path = args.contract or Path(os.getenv("EXPLOIT_CONTRACT_PATH", "contracts/SimpleBank.sol"))
    if not contract_path.is_absolute():
        contract_path = (project_root / contract_path).resolve()
    if not contract_path.exists():
        print(f"Error: Contract not found: {contract_path}")
        return 1

    output_dir = args.output or Path(os.getenv("EXPLOIT_OUTPUT_DIR", "exploit_results"))
    config_path = args.config or os.getenv("EXPLOIT_CONFIG", "foundry_exploit.yaml")
    docker_image = args.image or os.getenv("EXPLOIT_DOCKER_IMAGE", "yudai/foundry-full:latest")

    cost_limit = args.cost_limit
    if cost_limit is None:
        cost_limit = float(os.getenv("EXPLOIT_COST_LIMIT", "5.0"))

    deployer_key = os.getenv("DEPLOYER_PRIVATE_KEY") or os.getenv("PRIVATE_KEY")
    if not deployer_key or deployer_key == "0x":
        print("Error: DEPLOYER_PRIVATE_KEY or PRIVATE_KEY must be set in .env")
        return 1

    player_address = os.getenv("PLAYER_ADDRESS")
    if not player_address:
        print("Error: PLAYER_ADDRESS must be set in .env")
        return 1

    balance_wei_env = os.getenv("PLAYER_BALANCE_WEI")
    balance_eth_env = os.getenv("PLAYER_BALANCE_ETH")
    if balance_wei_env:
        player_balance_wei = parse_balance_wei(balance_wei_env)
    elif balance_eth_env:
        player_balance_wei = int(float(balance_eth_env) * 10**18)
    else:
        player_balance_wei = 100000 * 10**18

    anvil_port = int(os.getenv("ANVIL_PORT", "8545"))
    fork_url = os.getenv("ETH_RPC_URL") or os.getenv("EXPLOIT_FORK_URL")
    fork_block = os.getenv("EXPLOIT_FORK_BLOCK")
    fork_block_number = int(fork_block) if fork_block else None

    episode_config = EpisodeConfig(
        contract_path=contract_path,
        output_dir=output_dir,
        model_name=model_name,
        config_path=config_path,
        docker_image=docker_image,
        cost_limit=cost_limit,
        yolo=not args.no_yolo,
        anvil_port=anvil_port,
        fork_url=fork_url if fork_url else None,
        fork_block_number=fork_block_number,
        deployer_private_key=deployer_key,
        player_address=player_address,
        player_balance_wei=player_balance_wei,
    )

    result = run_local_exploit_episode(episode_config)

    print(f"Episode ID: {result.episode_id}")
    print(f"Target: {result.contract_name} @ {result.target_address}")
    print(f"Success: {result.success}")
    print(f"Profit: {result.profit_native_token:.6f}")
    print(f"Results saved to: {output_dir / f'{result.episode_id}.result.json'}")

    return 0 if result.success else 1


if __name__ == "__main__":
    raise SystemExit(main())
