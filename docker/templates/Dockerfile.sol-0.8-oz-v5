# =============================================================================
# SOLIDITY 0.8.x + OPENZEPPELIN v5 TEMPLATE
# =============================================================================
# For contracts using OpenZeppelin v5 (latest, 2024+)
# New features: Namespaced storage, custom errors, improved gas efficiency
#
# Build: docker build -t yudai-sol-0.8-oz-v5:latest -f docker/templates/Dockerfile.sol-0.8-oz-v5 .
# Usage: Copy /templates/sol-0.8-oz-v5 to workspace
# =============================================================================

FROM yudai-base:latest

LABEL template.name="sol-0.8-oz-v5"
LABEL template.solc="0.8.24"
LABEL template.dependencies="OpenZeppelin Contracts v5.0.2"
LABEL template.use-case="Contracts using OpenZeppelin v5 (latest)"

# Set solc version for this template
RUN . /opt/venv-main/bin/activate && solc-select use 0.8.24

# Create template directory
WORKDIR /templates/sol-0.8-oz-v5

# Initialize Foundry project
RUN forge init --no-commit --no-git .

# Install OpenZeppelin Contracts v5.0.2
RUN forge install OpenZeppelin/openzeppelin-contracts@v5.0.2 --no-commit

# Configure foundry.toml with OpenZeppelin remappings
RUN cat > foundry.toml <<'EOF'
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
solc = "0.8.24"

[profile.default.optimizer]
enabled = true
runs = 200

evm_version = "paris"
via_ir = false

# OpenZeppelin remappings
[profile.default.remappings]
"@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/"
"@openzeppelin/=lib/openzeppelin-contracts/"
EOF

# Create a sample ERC20 token to verify OpenZeppelin v5 works
RUN cat > src/SampleToken.sol <<'EOF'
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract SampleToken is ERC20, Ownable {
    // OpenZeppelin v5 uses custom errors
    error InvalidAmount();

    constructor() ERC20("Sample Token", "SMPL") Ownable(msg.sender) {
        _mint(msg.sender, 1000000 * 10 ** decimals());
    }

    function mint(address to, uint256 amount) public onlyOwner {
        if (amount == 0) revert InvalidAmount();
        _mint(to, amount);
    }

    function burn(uint256 amount) public {
        if (amount == 0) revert InvalidAmount();
        _burn(msg.sender, amount);
    }
}
EOF

# Create a sample test
RUN cat > test/SampleToken.t.sol <<'EOF'
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "../src/SampleToken.sol";

contract SampleTokenTest is Test {
    SampleToken public token;
    address public owner = address(this);
    address public user = address(0x1);

    function setUp() public {
        token = new SampleToken();
    }

    function testInitialSupply() public {
        assertEq(token.totalSupply(), 1000000 * 10 ** 18);
        assertEq(token.balanceOf(owner), 1000000 * 10 ** 18);
    }

    function testMint() public {
        uint256 mintAmount = 1000 * 10 ** 18;
        token.mint(user, mintAmount);
        assertEq(token.balanceOf(user), mintAmount);
    }

    function testBurn() public {
        uint256 burnAmount = 100 * 10 ** 18;
        token.burn(burnAmount);
        assertEq(token.totalSupply(), (1000000 - 100) * 10 ** 18);
    }

    function testOnlyOwnerCanMint() public {
        vm.prank(user);
        vm.expectRevert();
        token.mint(user, 1000);
    }

    function testCannotMintZero() public {
        vm.expectRevert(SampleToken.InvalidAmount.selector);
        token.mint(user, 0);
    }
}
EOF

# Verify template compiles and tests pass
RUN forge build && forge test && echo "✓ Template verified: sol-0.8-oz-v5"

# Clean build artifacts but keep lib/
RUN rm -rf out cache

# Create README for the template
RUN cat > README.md <<'EOF'
# Solidity 0.8.x + OpenZeppelin v5 Template

This template includes OpenZeppelin Contracts v5.0.2, the latest version with improved gas efficiency and custom errors.

## What's New in v5

- ✅ Custom errors by default (gas efficient)
- ✅ Namespaced storage for upgradeable contracts
- ✅ Improved Ownable (requires initial owner in constructor)
- ✅ Better type safety
- ❌ Removed SafeMath (redundant in 0.8.x)

## Usage

Copy this template to your workspace:
```bash
cp -r /templates/sol-0.8-oz-v5 /workspace
```

## Import Examples

```solidity
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Pausable.sol";
```

## Configuration

- **Solidity Version**: 0.8.24 (latest)
- **EVM Version**: paris
- **Dependencies**: OpenZeppelin Contracts v5.0.2
- **Optimizer**: Enabled (200 runs)

## Breaking Changes from v4

### 1. Ownable Constructor
```solidity
// v4: Ownable()
// v5: Ownable(msg.sender)
constructor() Ownable(msg.sender) {
    // ...
}
```

### 2. Custom Errors
```solidity
// Now built-in to OZ contracts
error OwnableUnauthorizedAccount(address account);
error OwnableInvalidOwner(address owner);
```

### 3. No More SafeMath
```solidity
// v4: SafeMath.add(a, b)
// v5: a + b  // Built-in overflow protection
```

## Testing

```bash
cd /workspace
forge build
forge test -vvv
forge coverage
```

## Common Patterns

### Modern ERC20 Token
```solidity
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract MyToken is ERC20, Ownable {
    // v5 requires initial owner
    constructor() ERC20("MyToken", "MTK") Ownable(msg.sender) {
        _mint(msg.sender, 1000000 * 10**18);
    }
}
```

### Reentrancy Protection
```solidity
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";

contract Bank is ReentrancyGuard {
    function withdraw() public nonReentrant {
        // Safe from reentrancy
    }
}
```

### Access Control with Custom Errors
```solidity
import "@openzeppelin/contracts/access/AccessControl.sol";

contract MyContract is AccessControl {
    bytes32 public constant MINTER_ROLE = keccak256("MINTER_ROLE");

    error UnauthorizedMinter(address caller);

    constructor() {
        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
    }

    function mint() public {
        if (!hasRole(MINTER_ROLE, msg.sender)) {
            revert UnauthorizedMinter(msg.sender);
        }
        // Mint logic
    }
}
```

## Migration from v4

1. **Update Ownable**: Add initial owner parameter
2. **Replace require with custom errors**: More gas efficient
3. **Remove SafeMath imports**: Use native operators
4. **Update tests**: Check for custom error selectors

## Version Compatibility

OpenZeppelin v5.0.2 requires:
- Solidity: ^0.8.20
- Foundry: Latest
- Hardhat: v2.x

## Downgrading to v4

If you need v4 compatibility, use the `sol-0.8-oz-v4` template instead.
EOF

WORKDIR /workspace
