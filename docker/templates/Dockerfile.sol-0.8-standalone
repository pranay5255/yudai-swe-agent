# =============================================================================
# SOLIDITY 0.8.x STANDALONE TEMPLATE
# =============================================================================
# For modern contracts (0.8.x) with no external dependencies
# Built-in overflow protection, modern syntax
#
# Build: docker build -t yudai-sol-0.8:latest -f docker/templates/Dockerfile.sol-0.8-standalone .
# Usage: Copy /templates/sol-0.8-standalone to workspace
# =============================================================================

FROM yudai-base:latest

LABEL template.name="sol-0.8-standalone"
LABEL template.solc="0.8.20"
LABEL template.dependencies="none"
LABEL template.use-case="Modern standalone contracts (0.8.x)"

# Set solc version for this template
RUN . /opt/venv-main/bin/activate && solc-select use 0.8.20

# Create template directory
WORKDIR /templates/sol-0.8-standalone

# Initialize Foundry project
RUN forge init --no-commit --no-git .

# Configure foundry.toml for Solidity 0.8.x
RUN cat > foundry.toml <<'EOF'
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
solc = "0.8.20"

[profile.default.optimizer]
enabled = true
runs = 200

# Use latest EVM features
evm_version = "paris"

# Modern compilation settings
via_ir = false
EOF

# Create a sample contract to verify compilation
RUN cat > src/Sample.sol <<'EOF'
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract Sample {
    uint256 public value;
    address public owner;

    event ValueChanged(uint256 oldValue, uint256 newValue);

    constructor() {
        owner = msg.sender;
    }

    function setValue(uint256 _value) public {
        require(msg.sender == owner, "Not owner");
        uint256 oldValue = value;
        value = _value;
        emit ValueChanged(oldValue, _value);
    }

    function getValue() public view returns (uint256) {
        return value;
    }
}
EOF

# Create a simple test
RUN cat > test/Sample.t.sol <<'EOF'
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "../src/Sample.sol";

contract SampleTest is Test {
    Sample public sample;

    function setUp() public {
        sample = new Sample();
    }

    function testSetValue() public {
        sample.setValue(42);
        assertEq(sample.getValue(), 42);
    }

    function testOwner() public {
        assertEq(sample.owner(), address(this));
    }
}
EOF

# Verify template compiles and tests pass
RUN forge build && forge test && echo "✓ Template verified: sol-0.8-standalone"

# Clean build artifacts but keep lib/
RUN rm -rf out cache

# Create README for the template
RUN cat > README.md <<'EOF'
# Solidity 0.8.x Standalone Template

This template is configured for Solidity 0.8.20 contracts with no external dependencies.

## Features

- ✅ Built-in overflow/underflow protection
- ✅ Modern constructor syntax
- ✅ Custom errors support
- ✅ Modern EVM version (Paris)

## Usage

Copy this template to your workspace:
```bash
cp -r /templates/sol-0.8-standalone /workspace
```

## Configuration

- **Solidity Version**: 0.8.20
- **EVM Version**: paris
- **Dependencies**: None
- **Optimizer**: Enabled (200 runs)

## Testing

```bash
cd /workspace
forge build
forge test
forge test -vvv  # Verbose output
```

## Common Patterns

### Custom Errors (Gas efficient)
```solidity
error Unauthorized();
error InvalidAmount(uint256 amount);

function transfer(uint256 amount) public {
    if (amount == 0) revert InvalidAmount(amount);
    if (msg.sender != owner) revert Unauthorized();
    // ...
}
```

### Events for Indexing
```solidity
event Transfer(address indexed from, address indexed to, uint256 amount);
emit Transfer(msg.sender, recipient, amount);
```
EOF

WORKDIR /workspace
