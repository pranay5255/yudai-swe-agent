# =============================================================================
# SOLIDITY 0.8.x + OPENZEPPELIN v4 TEMPLATE
# =============================================================================
# For contracts using OpenZeppelin v4 (most common in 2022-2023)
# Includes: ERC20, ERC721, Ownable, ReentrancyGuard, etc.
#
# Build: docker build -t yudai-sol-0.8-oz-v4:latest -f docker/templates/Dockerfile.sol-0.8-oz-v4 .
# Usage: Copy /templates/sol-0.8-oz-v4 to workspace
# =============================================================================

FROM yudai-base:latest

LABEL template.name="sol-0.8-oz-v4"
LABEL template.solc="0.8.20"
LABEL template.dependencies="OpenZeppelin Contracts v4.9.6"
LABEL template.use-case="Contracts using OpenZeppelin v4"

# Set solc version for this template
RUN . /opt/venv-main/bin/activate && solc-select use 0.8.20

# Create template directory
WORKDIR /templates/sol-0.8-oz-v4

# Initialize Foundry project
RUN forge init --no-commit --no-git .

# Install OpenZeppelin Contracts v4.9.6
RUN forge install OpenZeppelin/openzeppelin-contracts@v4.9.6 --no-commit

# Configure foundry.toml with OpenZeppelin remappings
RUN cat > foundry.toml <<'EOF'
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
solc = "0.8.20"

[profile.default.optimizer]
enabled = true
runs = 200

evm_version = "paris"
via_ir = false

# OpenZeppelin remappings
[profile.default.remappings]
"@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/"
"@openzeppelin/=lib/openzeppelin-contracts/"
EOF

# Create a sample ERC20 token to verify OpenZeppelin works
RUN cat > src/SampleToken.sol <<'EOF'
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract SampleToken is ERC20, Ownable {
    constructor() ERC20("Sample Token", "SMPL") {
        _mint(msg.sender, 1000000 * 10 ** decimals());
    }

    function mint(address to, uint256 amount) public onlyOwner {
        _mint(to, amount);
    }

    function burn(uint256 amount) public {
        _burn(msg.sender, amount);
    }
}
EOF

# Create a sample test
RUN cat > test/SampleToken.t.sol <<'EOF'
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "../src/SampleToken.sol";

contract SampleTokenTest is Test {
    SampleToken public token;
    address public user = address(0x1);

    function setUp() public {
        token = new SampleToken();
    }

    function testInitialSupply() public {
        assertEq(token.totalSupply(), 1000000 * 10 ** 18);
        assertEq(token.balanceOf(address(this)), 1000000 * 10 ** 18);
    }

    function testMint() public {
        uint256 mintAmount = 1000 * 10 ** 18;
        token.mint(user, mintAmount);
        assertEq(token.balanceOf(user), mintAmount);
    }

    function testBurn() public {
        uint256 burnAmount = 100 * 10 ** 18;
        token.burn(burnAmount);
        assertEq(token.totalSupply(), (1000000 - 100) * 10 ** 18);
    }

    function testOnlyOwnerCanMint() public {
        vm.prank(user);
        vm.expectRevert();
        token.mint(user, 1000);
    }
}
EOF

# Verify template compiles and tests pass
RUN forge build && forge test && echo "âœ“ Template verified: sol-0.8-oz-v4"

# Clean build artifacts but keep lib/
RUN rm -rf out cache

# Create README for the template
RUN cat > README.md <<'EOF'
# Solidity 0.8.x + OpenZeppelin v4 Template

This template includes OpenZeppelin Contracts v4.9.6, the most widely used version.

## Included Libraries

- **ERC20**: Fungible tokens
- **ERC721**: NFTs
- **ERC1155**: Multi-token standard
- **Ownable**: Access control
- **AccessControl**: Role-based permissions
- **ReentrancyGuard**: Reentrancy protection
- **Pausable**: Emergency stop
- **SafeMath**: (Not needed in 0.8.x but available)

## Usage

Copy this template to your workspace:
```bash
cp -r /templates/sol-0.8-oz-v4 /workspace
```

## Import Examples

```solidity
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/security/Pausable.sol";
import "@openzeppelin/contracts/utils/math/SafeMath.sol";
```

## Configuration

- **Solidity Version**: 0.8.20
- **EVM Version**: paris
- **Dependencies**: OpenZeppelin Contracts v4.9.6
- **Optimizer**: Enabled (200 runs)

## Testing

```bash
cd /workspace
forge build
forge test -vvv
forge coverage
```

## Common Patterns

### Secure ERC20 Token
```solidity
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract MyToken is ERC20, Ownable {
    constructor() ERC20("MyToken", "MTK") {
        _mint(msg.sender, 1000000 * 10**18);
    }
}
```

### Reentrancy Protection
```solidity
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract Bank is ReentrancyGuard {
    function withdraw() public nonReentrant {
        // Safe from reentrancy
    }
}
```

### Access Control
```solidity
import "@openzeppelin/contracts/access/AccessControl.sol";

contract MyContract is AccessControl {
    bytes32 public constant MINTER_ROLE = keccak256("MINTER_ROLE");

    constructor() {
        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
    }

    function mint() public onlyRole(MINTER_ROLE) {
        // Only minters can call
    }
}
```

## Version Compatibility

OpenZeppelin v4.9.6 is compatible with:
- Solidity: ^0.8.0
- Foundry: Latest
- Hardhat: v2.x

## Upgrading to v5

If you need v5, use the `sol-0.8-oz-v5` template instead.
Key differences in v5:
- Namespaced storage
- Custom errors by default
- Removed SafeMath (redundant in 0.8.x)
EOF

WORKDIR /workspace
