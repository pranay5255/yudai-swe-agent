#!/usr/bin/env python3
"""Beautiful terminal logging and UI for benchmark exploit runs.

This module provides rich, colorful terminal output for tracking
benchmark execution progress with detailed information about:
- Docker environment setup
- LLM agent interactions
- Mini-swe-agent framework status
- Real-time progress tracking
"""

from __future__ import annotations

import time
from dataclasses import dataclass, field
from typing import Any

from rich.align import Align
from rich.box import DOUBLE, HEAVY, ROUNDED
from rich.console import Console, Group
from rich.layout import Layout
from rich.live import Live
from rich.logging import RichHandler
from rich.panel import Panel
from rich.rule import Rule
from rich.table import Table
from rich.text import Text
from rich.theme import Theme

# Custom theme for consistent styling
BENCHMARK_THEME = Theme(
    {
        "info": "cyan",
        "success": "green",
        "warning": "yellow",
        "error": "red bold",
        "highlight": "magenta",
        "dim": "dim",
        "header": "blue bold",
        "metric": "bright_cyan",
        "label": "bright_blue",
    }
)

console = Console(theme=BENCHMARK_THEME, force_terminal=True)


@dataclass
class CaseProgress:
    """Track progress of a single benchmark case."""

    name: str
    index: int
    total: int
    status: str = "pending"  # pending, running, success, failed, interrupted
    start_time: float | None = None
    end_time: float | None = None
    stage: str = ""
    stage_progress: float = 0.0
    metrics: dict[str, Any] = field(default_factory=dict)
    error: str | None = None

    @property
    def duration(self) -> float:
        if self.start_time is None:
            return 0.0
        end = self.end_time or time.time()
        return end - self.start_time

    @property
    def duration_str(self) -> str:
        return format_duration(self.duration)


@dataclass
class RunState:
    """Overall state of a benchmark run."""

    run_id: str
    model_name: str
    docker_image: str
    total_cases: int
    cases: list[CaseProgress] = field(default_factory=list)
    current_case_index: int = -1
    start_time: float = field(default_factory=time.time)
    config_path: str = ""
    cost_limit: float = 0.0

    @property
    def completed_cases(self) -> int:
        return sum(1 for c in self.cases if c.status in ("success", "failed", "interrupted"))

    @property
    def successful_cases(self) -> int:
        return sum(1 for c in self.cases if c.status == "success")

    @property
    def failed_cases(self) -> int:
        return sum(1 for c in self.cases if c.status == "failed")

    @property
    def total_duration(self) -> float:
        return time.time() - self.start_time

    @property
    def estimated_remaining(self) -> float:
        completed = self.completed_cases
        if completed == 0:
            return 0.0
        avg_time = self.total_duration / completed
        remaining_cases = self.total_cases - completed
        return avg_time * remaining_cases


def format_duration(seconds: float) -> str:
    """Format seconds as human-readable duration."""
    if seconds < 60:
        return f"{seconds:.1f}s"
    elif seconds < 3600:
        minutes = int(seconds // 60)
        secs = int(seconds % 60)
        return f"{minutes}m {secs}s"
    else:
        hours = int(seconds // 3600)
        minutes = int((seconds % 3600) // 60)
        return f"{hours}h {minutes}m"


def create_header_panel(title: str, subtitle: str = "") -> Panel:
    """Create a beautiful header panel."""
    title_text = Text(title, style="header", justify="center")
    if subtitle:
        subtitle_text = Text(subtitle, style="dim", justify="center")
        content = Group(title_text, subtitle_text)
    else:
        content = title_text
    return Panel(
        Align.center(content),
        box=DOUBLE,
        border_style="blue",
        padding=(1, 2),
    )


def create_config_table(state: RunState) -> Table:
    """Create a table showing run configuration."""
    table = Table(
        title="‚öôÔ∏è  Configuration",
        box=ROUNDED,
        border_style="cyan",
        show_header=False,
        padding=(0, 2),
    )
    table.add_column("Setting", style="label", justify="right")
    table.add_column("Value", style="metric")

    table.add_row("Run ID", state.run_id[:20] + "...")
    table.add_row("Model", state.model_name)
    table.add_row("Docker Image", state.docker_image)
    table.add_row("Config", state.config_path)
    table.add_row("Cost Limit", f"${state.cost_limit:.2f}")
    table.add_row("Total Cases", str(state.total_cases))

    return table


def create_progress_panel(state: RunState) -> Panel:
    """Create the main progress panel with all cases."""
    if not state.cases:
        return Panel("No cases loaded", title="Progress", border_style="yellow")

    table = Table(
        box=ROUNDED,
        show_header=True,
        header_style="bold",
        padding=(0, 1),
        expand=True,
    )
    table.add_column("#", width=3, justify="right")
    table.add_column("Case Name", min_width=20)
    table.add_column("Status", width=12)
    table.add_column("Stage", min_width=15)
    table.add_column("Duration", width=10, justify="right")
    table.add_column("Progress", width=20)

    for case in state.cases:
        # Status with emoji and color
        status_styles = {
            "pending": ("‚è≥", "dim"),
            "running": ("‚ñ∂Ô∏è", "cyan"),
            "success": ("‚úÖ", "green"),
            "failed": ("‚ùå", "red"),
            "interrupted": ("‚èπÔ∏è", "yellow"),
        }
        emoji, style = status_styles.get(case.status, ("‚ùì", "white"))
        status_text = Text(f"{emoji} {case.status.upper()}", style=style)

        # Progress bar
        if case.status == "running":
            progress = case.stage_progress
            filled = int(progress * 15)
            bar = "‚ñà" * filled + "‚ñë" * (15 - filled)
            progress_text = f"{bar} {progress * 100:.0f}%"
        elif case.status == "success":
            progress_text = "‚úì Complete"
        elif case.status == "failed":
            progress_text = "‚úó Failed"
        else:
            progress_text = "-"

        # Highlight current case
        row_style = "bold" if case.index == state.current_case_index else None

        table.add_row(
            str(case.index + 1),
            case.name,
            status_text,
            case.stage or "-",
            case.duration_str,
            progress_text,
            style=row_style,
        )

    # Summary stats
    completed = state.completed_cases
    successful = state.successful_cases
    failed = state.failed_cases

    summary = Text()
    summary.append(f"Completed: {completed}/{state.total_cases} ", style="")
    summary.append(f"‚úì {successful} ", style="green")
    summary.append(f"‚úó {failed} ", style="red")
    if completed < state.total_cases:
        eta = format_duration(state.estimated_remaining)
        summary.append(f"| ETA: {eta}", style="dim")

    return Panel(
        Group(table, Rule(style="dim"), summary),
        title=f"üìä Progress ({completed}/{state.total_cases})",
        border_style="cyan",
        padding=(1, 1),
    )


def create_stage_detail_panel(case: CaseProgress | None) -> Panel:
    """Create panel showing detailed stage information for current case."""
    if case is None or case.status == "pending":
        return Panel(
            Text("Waiting to start...", style="dim", justify="center"),
            title="üîç Current Stage",
            border_style="dim",
        )

    if case.status == "success":
        content = Text("‚úì Case completed successfully", style="green", justify="center")
        return Panel(content, title="üîç Current Stage", border_style="green")

    if case.status == "failed":
        error_msg = case.error or "Unknown error"
        content = Text(f"‚úó {error_msg}", style="red", justify="center")
        return Panel(content, title="üîç Current Stage", border_style="red")

    # Running case - show detailed stage info
    stage_info = {
        "workspace": ("üìÅ", "Setting up workspace", "Creating Foundry project structure"),
        "config": ("‚öôÔ∏è", "Loading configuration", "Reading agent config file"),
        "environment": ("üê≥", "Initializing Docker", "Starting container and connecting"),
        "anvil": ("‚õìÔ∏è", "Starting Anvil fork", "Forking blockchain at target block"),
        "funding": ("üí∞", "Funding player account", "Setting up initial balance"),
        "build": ("üî®", "Building project", "Compiling Solidity contracts"),
        "agent": ("ü§ñ", "Initializing agent", "Setting up LLM and environment"),
        "execution": ("üöÄ", "Agent executing", "Running exploit generation"),
    }

    emoji, title, description = stage_info.get(case.stage.lower(), ("‚ö°", case.stage, "Processing..."))

    # Create stage progress visualization
    stage_progress = case.stage_progress
    filled = int(stage_progress * 30)
    bar = "‚ñà" * filled + "‚ñë" * (30 - filled)

    content = Group(
        Text(f"{emoji} {title}", style="header", justify="center"),
        Text(description, style="dim", justify="center"),
        Text(),
        Text(f"{bar} {stage_progress * 100:.0f}%", style="cyan", justify="center"),
        Text(f"Duration: {case.duration_str}", style="dim", justify="center"),
    )

    return Panel(
        content,
        title=f"üîç Stage: {case.stage or 'Initializing'}",
        border_style="cyan",
        padding=(1, 2),
    )


def create_metrics_panel(case: CaseProgress | None) -> Panel:
    """Create panel showing metrics for completed/current case."""
    if case is None or case.status == "pending":
        return Panel(
            Text("No metrics available", style="dim", justify="center"),
            title="üìà Metrics",
            border_style="dim",
        )

    table = Table(
        box=ROUNDED,
        show_header=False,
        padding=(0, 2),
        expand=True,
    )
    table.add_column("Metric", style="label")
    table.add_column("Value", style="metric", justify="right")

    # Add standard metrics
    table.add_row("Duration", case.duration_str)
    table.add_row("Status", case.status.upper())

    # Add case-specific metrics
    for key, value in case.metrics.items():
        if isinstance(value, float):
            if "profit" in key.lower():
                table.add_row(key.replace("_", " ").title(), f"{value:.6f} ETH")
            elif "cost" in key.lower():
                table.add_row(key.replace("_", " ").title(), f"${value:.4f}")
            else:
                table.add_row(key.replace("_", " ").title(), f"{value:.4f}")
        else:
            table.add_row(key.replace("_", " ").title(), str(value))

    return Panel(
        table, title=f"üìà Metrics: {case.name}", border_style="green" if case.status == "success" else "yellow"
    )


def create_docker_status_panel() -> Panel:
    """Create panel showing Docker environment status."""
    # This would be populated with real Docker status in practice
    indicators = [
        ("üê≥", "Container", "Ready", "green"),
        ("‚õìÔ∏è", "Anvil RPC", "Connected", "green"),
        ("üíæ", "Volume", "Mounted", "green"),
        ("üîå", "Network", "Active", "green"),
    ]

    table = Table(
        box=ROUNDED,
        show_header=False,
        padding=(0, 2),
        expand=True,
    )
    table.add_column("Icon", width=3)
    table.add_column("Component", style="label")
    table.add_column("Status", justify="right")

    for icon, component, status, color in indicators:
        table.add_row(icon, component, Text(status, style=color))

    return Panel(table, title="üê≥ Docker Environment", border_style="blue")


def create_llm_status_panel(state: RunState) -> Panel:
    """Create panel showing LLM agent status."""
    current = state.current_case_index
    if current < 0 or current >= len(state.cases):
        status_text = Text("Waiting to start...", style="dim")
    else:
        case = state.cases[current]
        if case.status == "running":
            status_text = Text(f"ü§ñ Executing: {case.name}", style="cyan")
        elif case.status == "success":
            status_text = Text(f"‚úì Completed: {case.name}", style="green")
        elif case.status == "failed":
            status_text = Text(f"‚úó Failed: {case.name}", style="red")
        else:
            status_text = Text("Idle", style="dim")

    table = Table(
        box=ROUNDED,
        show_header=False,
        padding=(0, 2),
        expand=True,
    )
    table.add_column("Setting", style="label")
    table.add_column("Value", style="metric")

    table.add_row("Model", state.model_name)
    table.add_row("Status", status_text)
    table.add_row("Cases Processed", f"{state.completed_cases}/{state.total_cases}")

    return Panel(table, title="ü§ñ LLM Agent", border_style="magenta")


class BenchmarkUI:
    """Rich terminal UI for benchmark runs - NON-LIVE VERSION.

    This version does NOT use Live display to avoid flickering.
    Instead, it prints static panels at key transition points.
    """

    def __init__(self, state: RunState):
        self.state = state
        self._last_update = 0
        self._update_interval = 5.0  # Minimum seconds between updates

    def _generate_layout(self) -> Layout:
        """Generate the full layout for the UI."""
        layout = Layout()

        # Header
        header = create_header_panel(
            "üî• Exploit Generation Benchmark", f"Run ID: {self.state.run_id[:16]}... | Model: {self.state.model_name}"
        )
        layout.split_column(
            Layout(header, size=5),
            Layout(name="main"),
            Layout(name="footer", size=3),
        )

        # Main content - split into left and right
        layout["main"].split_row(
            Layout(name="left", ratio=2),
            Layout(name="right", ratio=1),
        )

        # Left side: Progress and current stage
        layout["left"].split_column(
            Layout(create_progress_panel(self.state), name="progress", ratio=2),
            Layout(create_stage_detail_panel(self._get_current_case()), name="stage", ratio=1),
        )

        # Right side: Config, Docker, LLM, Metrics
        right_panels = [
            create_config_table(self.state),
            create_docker_status_panel(),
            create_llm_status_panel(self.state),
        ]

        # Add metrics for current case if available
        current_case = self._get_current_case()
        if current_case and current_case.metrics:
            right_panels.append(create_metrics_panel(current_case))

        layout["right"].split_column(*[Layout(panel) for panel in right_panels])

        # Footer with time info
        elapsed = format_duration(self.state.total_duration)
        eta = format_duration(self.state.estimated_remaining) if self.state.completed_cases > 0 else "--"
        footer_text = Text(
            f"‚è±Ô∏è  Elapsed: {elapsed} | ‚è≥ ETA: {eta} | Press Ctrl+C to interrupt",
            style="dim",
            justify="center",
        )
        layout["footer"].update(Panel(footer_text, box=ROUNDED, border_style="dim"))

        return layout

    def _get_current_case(self) -> CaseProgress | None:
        """Get the currently running case."""
        if self.state.current_case_index < 0 or self.state.current_case_index >= len(self.state.cases):
            return None
        return self.state.cases[self.state.current_case_index]

    def start(self):
        """Start the UI - prints initial state."""
        # Clear screen and print initial layout once
        console.clear()
        console.print(self._generate_layout())
        self._last_update = time.time()

    def stop(self):
        """Stop the UI - nothing to do for static version."""
        pass

    def update(self, force: bool = False):
        """Update the UI display - only if enough time has passed or force=True."""
        now = time.time()
        if force or (now - self._last_update >= self._update_interval):
            console.clear()
            console.print(self._generate_layout())
            self._last_update = now

    def refresh(self):
        """Force refresh of the UI."""
        self.update(force=True)


def print_run_start(state: RunState):
    """Print beautiful run start banner."""
    console.print()
    console.print(
        create_header_panel("üî• Exploit Generation Benchmark V2", f"Starting run with {state.total_cases} case(s)")
    )
    console.print()

    # Configuration summary
    config_table = Table(
        title="‚öôÔ∏è  Run Configuration",
        box=ROUNDED,
        show_header=False,
        padding=(0, 2),
    )
    config_table.add_column("Setting", style="cyan")
    config_table.add_column("Value", style="white")

    config_table.add_row("Run ID", state.run_id)
    config_table.add_row("Model", state.model_name)
    config_table.add_row("Docker Image", state.docker_image)
    config_table.add_row("Config Path", state.config_path)
    config_table.add_row("Cost Limit", f"${state.cost_limit:.2f}")
    config_table.add_row("Total Cases", str(state.total_cases))

    console.print(config_table)
    console.print()

    # Cases list
    cases_table = Table(
        title="üìã Cases to Run",
        box=ROUNDED,
        show_header=True,
        header_style="bold cyan",
    )
    cases_table.add_column("#", justify="right", width=3)
    cases_table.add_column("Case Name", min_width=20)
    cases_table.add_column("Chain", width=10)
    cases_table.add_column("Block", width=10)
    cases_table.add_column("Target Contract", min_width=25)

    for i, case in enumerate(state.cases):
        cases_table.add_row(
            str(i + 1),
            case.name,
            case.metrics.get("chain", "-"),
            str(case.metrics.get("fork_block_number", "-")),
            case.metrics.get("target_contract_address", "-")[:20] + "...",
        )

    console.print(cases_table)
    console.print()
    console.print(Rule(style="cyan"))


def print_case_start(case: CaseProgress):
    """Print case start banner."""
    console.print()
    console.print(
        Panel(
            f"[bold cyan]‚ñ∂ Case {case.index + 1}/{case.total}: {case.name}[/bold cyan]",
            box=HEAVY,
            border_style="cyan",
            padding=(1, 2),
        )
    )


def print_case_complete(case: CaseProgress):
    """Print case completion summary."""
    if case.status == "success":
        border_style = "green"
        icon = "‚úÖ"
        title = "SUCCESS"
    elif case.status == "failed":
        border_style = "red"
        icon = "‚ùå"
        title = "FAILED"
    else:
        border_style = "yellow"
        icon = "‚èπÔ∏è"
        title = "INTERRUPTED"

    content = Group(
        Text(f"{icon} Case {case.name}: {title}", style=border_style, justify="center"),
        Text(f"Duration: {case.duration_str}", style="dim", justify="center"),
    )

    if case.metrics:
        metrics_text = Text()
        for key, value in case.metrics.items():
            if isinstance(value, float):
                if "profit" in key.lower():
                    metrics_text.append(f"\nProfit: {value:.6f} ETH", style="green" if value > 0 else "red")
                elif "cost" in key.lower():
                    metrics_text.append(f"\nCost: ${value:.4f}", style="yellow")
        content = Group(content, metrics_text)

    console.print(
        Panel(
            content,
            box=ROUNDED,
            border_style=border_style,
            padding=(1, 2),
        )
    )


def print_run_summary(state: RunState, results: list[dict]):
    """Print beautiful run summary."""
    console.print()
    console.print(Rule(style="cyan"))
    console.print()

    # Summary header
    success_count = state.successful_cases
    fail_count = state.failed_cases
    total = state.total_cases

    if success_count == total:
        header_style = "green"
        header_icon = "üéâ"
        header_text = "ALL CASES PASSED"
    elif success_count > 0:
        header_style = "yellow"
        header_icon = "‚ö†Ô∏è"
        header_text = "PARTIAL SUCCESS"
    else:
        header_style = "red"
        header_icon = "üí•"
        header_text = "ALL CASES FAILED"

    console.print(
        Panel(
            Text(f"{header_icon} {header_text}", style=f"bold {header_style}", justify="center"),
            box=DOUBLE,
            border_style=header_style,
            padding=(1, 2),
        )
    )

    # Stats table
    stats_table = Table(
        title="üìä Final Statistics",
        box=ROUNDED,
        show_header=False,
        padding=(0, 4),
    )
    stats_table.add_column("Metric", style="cyan")
    stats_table.add_column("Value", justify="right")

    stats_table.add_row("Total Cases", str(total))
    stats_table.add_row("Successful", f"[green]{success_count}[/green]")
    stats_table.add_row("Failed", f"[red]{fail_count}[/red]")
    stats_table.add_row("Total Duration", format_duration(state.total_duration))

    if results:
        total_cost = sum(r.get("cost", 0) for r in results)
        total_profit = sum(r.get("profit", 0) for r in results if r.get("success"))
        stats_table.add_row("Total Cost", f"${total_cost:.4f}")
        stats_table.add_row("Total Profit", f"{total_profit:.6f} ETH")

    console.print()
    console.print(stats_table)

    # Results table
    if results:
        console.print()
        results_table = Table(
            title="üìã Detailed Results",
            box=ROUNDED,
            show_header=True,
            header_style="bold",
        )
        results_table.add_column("Case", min_width=20)
        results_table.add_column("Status", width=10)
        results_table.add_column("Profit (ETH)", justify="right", width=15)
        results_table.add_column("Cost ($)", justify="right", width=12)

        for r in results:
            status = "‚úì" if r.get("success") else "‚úó"
            status_style = "green" if r.get("success") else "red"
            profit = r.get("profit", 0)
            cost = r.get("cost", 0)

            results_table.add_row(
                r["case_name"],
                Text(status, style=status_style),
                f"{profit:.6f}",
                f"${cost:.4f}",
            )

        console.print(results_table)

    console.print()
    console.print(f"[dim]Run log saved to: {state.run_id}.json[/dim]")
    console.print()


def print_stage_transition(case: CaseProgress, stage: str, description: str = ""):
    """Print a stage transition message."""
    stage_icons = {
        "workspace": "üìÅ",
        "config": "‚öôÔ∏è",
        "environment": "üê≥",
        "anvil": "‚õìÔ∏è",
        "funding": "üí∞",
        "build": "üî®",
        "agent": "ü§ñ",
        "execution": "üöÄ",
    }
    icon = stage_icons.get(stage.lower(), "‚ö°")

    if description:
        console.print(f"[dim]{icon} {stage}:[/dim] {description}")
    else:
        console.print(f"[dim]{icon} {stage}...[/dim]")


def create_logging_handler(verbose: bool = False) -> RichHandler:
    """Create a Rich logging handler for beautiful log output."""
    return RichHandler(
        console=console,
        show_time=True,
        show_path=verbose,
        show_level=True,
        rich_tracebacks=True,
        tracebacks_show_locals=verbose,
        markup=True,
    )


def configure_logging(verbose: bool = False) -> None:
    """Configure beautiful logging with Rich."""
    import logging

    handler = create_logging_handler(verbose)
    handler.setFormatter(
        logging.Formatter(
            fmt="%(message)s",
            datefmt="[%X]",
        )
    )

    logging.basicConfig(
        level=logging.DEBUG if verbose else logging.INFO,
        handlers=[handler],
    )

    # Reduce noise from libraries
    logging.getLogger("httpx").setLevel(logging.WARNING)
    logging.getLogger("httpcore").setLevel(logging.WARNING)
    logging.getLogger("urllib3").setLevel(logging.WARNING)
    logging.getLogger("docker").setLevel(logging.INFO)


# For compatibility with existing code
def print_banner(text: str):
    """Print a simple banner."""
    console.print()
    console.print(
        Panel(
            Text(text, justify="center"),
            box=DOUBLE,
            border_style="cyan",
        )
    )
    console.print()


def print_info(label: str, value: str):
    """Print an info line."""
    console.print(f"[cyan]{label}:[/cyan] {value}")


def print_success(text: str):
    """Print a success message."""
    console.print(f"[green]‚úì {text}[/green]")


def print_error(text: str):
    """Print an error message."""
    console.print(f"[red]‚úó {text}[/red]")


def print_warning(text: str):
    """Print a warning message."""
    console.print(f"[yellow]‚ö† {text}[/yellow]")
