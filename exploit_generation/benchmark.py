"""Load and manage benchmark cases from CSV."""

import csv
from pathlib import Path

from exploit_generation.models import BenchmarkCase
from exploit_generation.source_fetcher import fetch_source_code, SourceCodeResult


def load_benchmark(csv_path: Path) -> list[BenchmarkCase]:
    """Load all benchmark cases from CSV file.

    Args:
        csv_path: Path to benchmark.csv

    Returns:
        List of BenchmarkCase objects
    """
    cases = []
    with csv_path.open() as f:
        reader = csv.DictReader(f)
        for row in reader:
            cases.append(BenchmarkCase.from_csv_row(row))
    return cases


def get_case_by_name(cases: list[BenchmarkCase], name: str) -> BenchmarkCase | None:
    """Find a case by name.

    Args:
        cases: List of benchmark cases
        name: Case name to find

    Returns:
        BenchmarkCase or None if not found
    """
    for case in cases:
        if case.case_name == name:
            return case
    return None


def filter_by_chain(cases: list[BenchmarkCase], chain: str) -> list[BenchmarkCase]:
    """Filter cases by chain.

    Args:
        cases: List of benchmark cases
        chain: Chain name (mainnet, bsc, base)

    Returns:
        Filtered list of cases
    """
    return [c for c in cases if c.chain == chain]


def enrich_case_with_source(
    case: BenchmarkCase,
    api_key: str | None = None,
    cache_dir: Path | None = None,
) -> BenchmarkCase:
    """Fetch source code from Etherscan and add to case.

    Args:
        case: Benchmark case to enrich
        api_key: Optional API key
        cache_dir: Optional cache directory

    Returns:
        BenchmarkCase with source_code, abi, and contract_name populated
    """
    try:
        result = fetch_source_code(
            address=case.target_contract_address,
            chain=case.chain,
            api_key=api_key,
            cache_dir=cache_dir,
        )
        case.source_code = result.source_code
        case.abi = result.abi
        case.contract_name = result.contract_name
    except Exception as e:
        print(f"Warning: Failed to fetch source for {case.case_name}: {e}")
    return case


def load_benchmark_with_sources(
    csv_path: Path,
    api_key: str | None = None,
    cache_dir: Path | None = None,
    chain_filter: str | None = None,
    limit: int | None = None,
) -> list[BenchmarkCase]:
    """Load benchmark cases and fetch source code for each.

    Args:
        csv_path: Path to benchmark.csv
        api_key: Optional API key for Etherscan
        cache_dir: Optional directory to cache fetched sources
        chain_filter: Optional chain to filter by
        limit: Optional max number of cases to load

    Returns:
        List of BenchmarkCase objects with source code populated
    """
    cases = load_benchmark(csv_path)

    if chain_filter:
        cases = filter_by_chain(cases, chain_filter)

    if limit:
        cases = cases[:limit]

    enriched = []
    for i, case in enumerate(cases):
        print(f"[{i+1}/{len(cases)}] Fetching source for {case.case_name} ({case.chain})...")
        enriched.append(enrich_case_with_source(case, api_key, cache_dir))

    return enriched


if __name__ == "__main__":
    import sys
    from dotenv import load_dotenv

    load_dotenv()

    # Find benchmark.csv
    project_root = Path(__file__).parent.parent
    csv_path = project_root / "benchmark.csv"

    if not csv_path.exists():
        print(f"benchmark.csv not found at {csv_path}")
        sys.exit(1)

    # Load cases
    cases = load_benchmark(csv_path)
    print(f"Loaded {len(cases)} benchmark cases")

    # Show chain distribution
    chains = {}
    for c in cases:
        chains[c.chain] = chains.get(c.chain, 0) + 1
    print(f"Chain distribution: {chains}")

    # Test fetching a single case
    if len(sys.argv) > 1:
        case_name = sys.argv[1]
        case = get_case_by_name(cases, case_name)
        if case:
            print(f"\nFetching source for {case_name}...")
            cache_dir = project_root / "cache" / "sources"
            enriched = enrich_case_with_source(case, cache_dir=cache_dir)
            if enriched.source_code:
                print(f"Contract: {enriched.contract_name}")
                print(f"Source length: {len(enriched.source_code)} chars")
                print(f"ABI functions: {len([x for x in enriched.abi if x.get('type') == 'function'])}")
            else:
                print("Failed to fetch source code")
        else:
            print(f"Case '{case_name}' not found")
