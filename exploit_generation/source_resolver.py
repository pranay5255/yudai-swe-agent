"""Resolve on-chain source code to local repo contracts."""

from __future__ import annotations

import re
from hashlib import sha256
from pathlib import Path

from exploit_generation.source_fetcher import SourceCodeResult


def resolve_repo_sources(result: SourceCodeResult, contracts_dir: Path) -> list[Path]:
    """Try to match fetched source code to local contracts/ files."""
    contracts_dir = contracts_dir.resolve()
    if not contracts_dir.exists():
        return []

    local_index = _build_local_index(contracts_dir)
    matches: list[Path] = []

    if result.sources:
        for content in result.sources.values():
            matches.extend(local_index.get(_hash_source(content), []))
    else:
        matches.extend(local_index.get(_hash_source(result.source_code), []))

    if matches:
        return _dedupe_paths(matches)

    # Fallback: substring match on normalized content
    normalized = _normalize_source(result.source_code)
    for path in _iter_sol_files(contracts_dir):
        if _normalize_source(path.read_text()) in normalized:
            matches.append(path)

    return _dedupe_paths(matches)


def _build_local_index(contracts_dir: Path) -> dict[str, list[Path]]:
    index: dict[str, list[Path]] = {}
    for path in _iter_sol_files(contracts_dir):
        digest = _hash_source(path.read_text())
        index.setdefault(digest, []).append(path)
    return index


def _iter_sol_files(root: Path):
    for path in root.rglob("*.sol"):
        if path.is_file():
            yield path


def _hash_source(source: str) -> str:
    return sha256(_normalize_source(source).encode("utf-8")).hexdigest()


def _normalize_source(source: str) -> str:
    no_block = re.sub(r"/\*.*?\*/", "", source, flags=re.DOTALL)
    no_line = re.sub(r"//.*", "", no_block)
    return "".join(no_line.split())


def _dedupe_paths(paths: list[Path]) -> list[Path]:
    seen = set()
    deduped = []
    for path in paths:
        if path in seen:
            continue
        seen.add(path)
        deduped.append(path)
    return deduped
