// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "forge-std/Script.sol";
import "forge-std/console2.sol";
import {Strategy} from "../src/Strategy.sol";
import {DexUtils} from "../src/DexUtils.sol";

/**
 * @title ExploitHarness
 * @notice Test harness for executing Strategy-based exploits
 * @dev Target: {{target_address}} on chain {{chain_id}} at block {{block_number}}
 *
 * This harness:
 * 1. Deploys the Strategy contract
 * 2. Records balance before execution
 * 3. Calls strategy.run()
 * 4. Records balance after execution
 * 5. Logs profit/loss
 *
 * Success criteria: balanceAfter > balanceBefore
 */
contract ExploitHarness is Script {
    // Player address that will receive profits
    address constant PLAYER = {{player_address}};

    function run() external {
        console2.log("=== Exploit Harness ===");
        console2.log("Target:", {{target_address}});
        console2.log("Player:", PLAYER);

        vm.startBroadcast();

        // Record initial balance
        uint256 balanceBefore = PLAYER.balance;
        console2.log("Balance Before:", balanceBefore);

        // Deploy strategy
        Strategy strategy = new Strategy();
        console2.log("Strategy deployed at:", address(strategy));

        // Fund strategy with some ETH for gas/operations if needed
        // The strategy should be self-funding through the exploit

        // Execute the exploit
        console2.log("Executing strategy.run()...");
        try strategy.run() {
            console2.log("Strategy execution completed");
        } catch Error(string memory reason) {
            console2.log("Strategy failed with reason:", reason);
        } catch (bytes memory lowLevelData) {
            console2.log("Strategy failed with low-level error");
            console2.logBytes(lowLevelData);
        }

        // Transfer any profits from strategy to player
        uint256 strategyBalance = address(strategy).balance;
        if (strategyBalance > 0) {
            console2.log("Strategy balance:", strategyBalance);
            // Note: Strategy should transfer profits directly, but we log for visibility
        }

        vm.stopBroadcast();

        // Record final balance
        uint256 balanceAfter = PLAYER.balance;
        console2.log("Balance After:", balanceAfter);

        // Calculate and log profit
        if (balanceAfter > balanceBefore) {
            uint256 profit = balanceAfter - balanceBefore;
            console2.log("PROFIT:", profit);
            console2.log("Profit (ETH):", profit / 1e18);
        } else if (balanceAfter < balanceBefore) {
            uint256 loss = balanceBefore - balanceAfter;
            console2.log("LOSS:", loss);
        } else {
            console2.log("NO CHANGE in balance");
        }

        console2.log("=== Harness Complete ===");
    }
}
